<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PECSB English Algeria â€” Demo Platform</title>
<style>
  :root{
    --blue:#1f6feb;--green:#10b981;--ink:#0f172a;--muted:#6b7280;
    --bg:#f8fafc;--card:#ffffff;--line:#e5e7eb;--red:#ef4444;--amber:#f59e0b;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:5}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand h1{font-size:18px;margin:0}
  nav{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  nav button{border:1px solid var(--line);background:#fff;padding:8px 10px;border-radius:10px;cursor:pointer}
  nav button.active{background:var(--blue);color:#fff;border-color:var(--blue)}
  main{padding:24px 0}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:repeat(3,1fr)}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
  .title{margin:0 0 8px 0;font-size:18px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select,textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row>div{flex:1 1 180px}
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .btn.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
  .btn.success{background:var(--green);color:#fff;border-color:var(--green)}
  .btn.warn{background:var(--amber);color:#fff;border-color:var(--amber)}
  .btn.danger{background:var(--red);color:#fff;border-color:var(--red)}
  .muted{color:var(--muted)} .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
  .kpi{font-size:24px;font-weight:700}
  .hide{display:none}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid var(--line);text-align:left;padding:8px}
  .badge{font-size:11px;border:1px solid var(--line);padding:2px 6px;border-radius:8px}
  .ok{color:#059669}.bad{color:#dc2626}.pending{color:#d97706}
  small.code{font-family:ui-monospace,Consolas,Menlo,monospace;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <img alt="PECSB" src="https://dummyimage.com/32x32/1f6feb/ffffff&text=P" width="32" height="32"/>
      <h1>PECSB English Algeria â€” Demo</h1>
    </div>
    <nav id="topnav"></nav>
  </div>
</header>

<main>
  <div class="wrap">
    <!-- dynamic pages render here -->
    <div id="app"></div>
  </div>
</main>

<footer class="wrap" style="padding-bottom:40px">
  <div class="muted">Â© 2025 PECSB Â· Demo app (front-end only) Â· Data stored in your browser (localStorage).</div>
</footer>

<script>
/* =========================
   UTIL & PERSISTENCE LAYER
   ========================= */
const $ = (sel, root=document)=>root.querySelector(sel);
const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));
const db = {
  get:(k,def=null)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):def}catch(e){return def}},
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),
  id:()=>Math.random().toString(36).slice(2,10)
};
// Seed data on first run
(function seed(){
  if(!db.get('seeded')){
    const teachers=[{
      id:db.id(), name:"Leila Ben", city:"Algiers", badges:["TESOL"], years:6,
      langs:["EN","AR","FR"], rating:4.9, taught:1020, programs:["GEP","AEP","GET"],
      levels:["A2","B1","B2"], status:"approved", bio:"I help students speak with confidence.",
      availability:["Mon 18:00","Tue 20:00","Thu 19:00"], priceTrial:0, priceStd:2500
    },{
      id:db.id(), name:"Karim M.", city:"Oran", badges:["CELTA"], years:8,
      langs:["EN","FR"], rating:4.8, taught:1330, programs:["GEP","Training"],
      levels:["A1","A2","B1"], status:"approved", bio:"Business English & presentations.",
      availability:["Sat 10:00","Sun 11:00"], priceTrial:0, priceStd:2600
    }];
    const students=[];
    const bookings=[]; // {id, studentId, teacherId, when, program, status, paid, receiptUrl, recordingUrl}
    const payments=[]; // {id, studentId, amount, method, receiptUrl, status}
    const users=[ // admin + demo teacher/student accounts
      {id:db.id(), role:'admin', email:'admin@pecsb.demo', pass:'admin123', name:'PECSB Admin'},
      {id:db.id(), role:'teacher', email:'leila@pecsb.demo', pass:'teacher123', name:'Leila Ben', linkId:teachers[0].id, approved:true},
      {id:db.id(), role:'student', email:'amina@pecsb.demo', pass:'student123', name:'Amina'}
    ];
    db.set('teachers',teachers);
    db.set('students',students);
    db.set('bookings',bookings);
    db.set('payments',payments);
    db.set('users',users);
    db.set('seeded',true);
  }
})();

const state={route:'home', me:null, flash:''};
function setRoute(route){ state.route=route; render(); }
function setFlash(msg){ state.flash=msg; setTimeout(()=>{state.flash=''; render();},2500); }

/* =========================
   NAVIGATION
   ========================= */
const routes = [
  {id:'home', label:'Home'},
  {id:'courses', label:'Courses'},
  {id:'placement', label:'Placement Test'},
  {id:'find', label:'Find a Teacher'},
  {id:'pricing', label:'Pricing & Scholarships'},
  {id:'how', label:'How It Works'},
  {id:'student', label:'Student Portal'},
  {id:'teacher', label:'Teacher Portal'},
  {id:'apply', label:'Apply as Teacher'},
  {id:'admin', label:'Admin'},
  {id:'support', label:'Support & Policies'}
];

function navView(){
  const nav = $('#topnav');
  nav.innerHTML='';
  routes.forEach(r=>{
    const b=document.createElement('button');
    b.textContent=r.label;
    b.className = state.route===r.id ? 'active' : '';
    b.onclick=()=>setRoute(r.id);
    nav.appendChild(b);
  });
}

/* =========================
   VIEWS
   ========================= */
function viewHome(){
  return `
    <div class="grid grid-2">
      <div class="card">
        <h2 class="title">Learn English Anytime, Anywhere in Algeria ðŸ‡©ðŸ‡¿</h2>
        <p class="muted">Trusted lessons with certified Algerian teachers â€” safe payments, recorded classes, and real results.</p>
        <div class="row">
          <button class="btn primary" onclick="setRoute('placement')">Take Free Placement Test</button>
          <button class="btn" onclick="setRoute('find')">Find Your Teacher</button>
        </div>
        <hr style="margin:16px 0;border:none;border-top:1px solid var(--line)"/>
        <div class="row">
          <span class="pill">Safe Payments</span>
          <span class="pill">Certified Teachers</span>
          <span class="pill">Recorded Classes</span>
          <span class="pill">Student Portal</span>
        </div>
      </div>
      <div class="card">
        <h3 class="title">Programs</h3>
        <ul>
          <li><b>GEP</b>: daily & workplace English (8 weeks)</li>
          <li><b>AEP</b>: academic English & presentations (8 weeks)</li>
          <li><b>Training</b>: specialist English (12 weeks)</li>
          <li><b>GET</b>: teenagers 13â€“18 (weekly)</li>
        </ul>
        <button class="btn" onclick="setRoute('courses')">Learn More</button>
      </div>
    </div>
  `;
}

function viewCourses(){
  return `
  <div class="grid grid-2">
    <div class="card">
      <h3 class="title">GEP â€” General English</h3>
      <p>Improve grammar, speaking, listening & writing through practical lessons.</p>
      <div class="row"><div><b>Duration:</b> 8 weeks</div><div><b>Level:</b> A1â€“B2</div></div>
      <div class="row"><div><b>Delivery:</b> Online or Center</div><div><b>Certificate:</b> PECSB</div></div>
    </div>
    <div class="card">
      <h3 class="title">AEP â€” Academic English</h3>
      <p>Essay writing, presentation skills, academic vocabulary, research basics.</p>
      <div class="row"><div><b>Duration:</b> 8 weeks</div><div><b>Level:</b> B1â€“C1</div></div>
      <div class="row"><div><b>Delivery:</b> Online or Center</div><div><b>Certificate:</b> PECSB + Partner</div></div>
    </div>
    <div class="card">
      <h3 class="title">Training â€” Specialized</h3>
      <p>Business English, Tourism, Oil & Gas, Customer Service, Job Interview English.</p>
      <div class="row"><div><b>Duration:</b> 12 weeks</div><div><b>Level:</b> all</div></div>
      <div class="row"><div><b>Delivery:</b> Online or Center</div><div><b>Certificate:</b> PECSB</div></div>
    </div>
    <div class="card">
      <h3 class="title">GET â€” Teenagers (13â€“18)</h3>
      <p>Fun, interactive lessons for school learners (speaking clubs, projects, games).</p>
      <div class="row"><div><b>Duration:</b> Weekly</div><div><b>Level:</b> Foundationâ€“B1</div></div>
      <div class="row"><div><b>Delivery:</b> Online or Center</div><div><b>Certificate:</b> PECSB</div></div>
    </div>
  </div>
  `;
}

function viewPlacement(){
  return `
  <div class="card">
    <h3 class="title">Placement Test â€” 20 minutes</h3>
    <p class="muted">Answer 20 quick questions (demo). Your level is shown instantly.</p>
    <div id="quiz"></div>
    <div class="row" style="margin-top:12px">
      <button class="btn primary" onclick="submitPlacement()">Submit Test</button>
    </div>
    <div id="quizResult" class="card hide" style="margin-top:12px"></div>
  </div>`;
}

function viewFind(){
  const teachers=db.get('teachers',[]);
  const cards=teachers.filter(t=>t.status==='approved').map(t=>`
    <div class="card">
      <div class="row" style="align-items:center">
        <div style="flex:0 0 64px">
          <img alt="${t.name}" src="https://dummyimage.com/64x64/e5e7eb/111&text=${t.name.split(' ')[0][0]}" style="border-radius:12px"/>
        </div>
        <div style="flex:1">
          <h4 class="title" style="margin:0">${t.name} <span class="badge">${t.city}</span></h4>
          <div class="muted" style="margin:4px 0">${t.badges.join(', ')} Â· ${t.years} yrs Â· â˜… ${t.rating} Â· ${t.taught} classes</div>
          <div><b>Programs:</b> ${t.programs.join(', ')} Â· <b>Levels:</b> ${t.levels.join(', ')}</div>
          <div class="muted">Available: ${t.availability.join(', ')}</div>
        </div>
        <div>
          <button class="btn" onclick="bookTrial('${t.id}')">Book Free Trial</button>
        </div>
      </div>
    </div>
  `).join('');
  return `<div class="grid">${cards||'<div class="muted">No teachers yet.</div>'}</div>`;
}

function viewPricing(){
  return `
  <div class="grid grid-3">
    <div class="card"><h3 class="title">Online (per course)</h3>
      <ul>
        <li>GEP: <b>50,000 DZD</b> (8 weeks)</li>
        <li>AEP: <b>55,000 DZD</b> (8 weeks)</li>
        <li>Training: <b>65,000 DZD</b> (12 weeks)</li>
        <li>GET: <b>8,000 DZD/week</b></li>
      </ul>
      <div class="muted">Scholarships: 30â€“40% off (merit/need).</div>
    </div>
    <div class="card"><h3 class="title">Center (per course)</h3>
      <ul>
        <li>GEP: <b>60,000 DZD</b> (8 weeks)</li>
        <li>AEP: <b>70,000 DZD</b> (8 weeks)</li>
        <li>Training: <b>80,000 DZD</b> (12 weeks)</li>
      </ul>
      <div class="muted">Phase 2 requires Ministry approval.</div>
    </div>
    <div class="card"><h3 class="title">University (per year)</h3>
      <ul>
        <li>Self-pay: <b>180â€“220k DZD</b></li>
        <li>Scholarship: <b>90â€“120k DZD</b></li>
      </ul>
    </div>
  </div>`;
}

function viewHow(){
  return `
  <div class="grid grid-2">
    <div class="card">
      <h3 class="title">Student Flow</h3>
      <ol>
        <li>Register â†’ Verify email/phone</li>
        <li>Take placement test â†’ Level shown</li>
        <li>Book a trial or enroll â†’ Pay/Upload receipt</li>
        <li>Attend class (recorded) â†’ Homework & feedback</li>
        <li>Complete â†’ Certificate with QR</li>
      </ol>
    </div>
    <div class="card">
      <h3 class="title">Teacher Flow</h3>
      <ol>
        <li>Apply â†’ Upload docs â†’ Book interview</li>
        <li>Pass training & sign contract</li>
        <li>Get approved â†’ Open availability</li>
        <li>Teach classes (auto-record)</li>
        <li>Monthly review â†’ Payouts</li>
      </ol>
    </div>
  </div>
  `;
}

/* ======= AUTH & PORTALS ======= */
function viewStudent(){
  if(state.me?.role==='student') return studentDashboard();
  return `
  <div class="grid grid-2">
    <div class="card">
      <h3 class="title">Student Login</h3>
      <label>Email</label><input id="sEmail" type="email">
      <label>Password</label><input id="sPass" type="password">
      <div class="row" style="margin-top:8px">
        <button class="btn primary" onclick="login('student')">Login</button>
      </div>
    </div>
    <div class="card">
      <h3 class="title">Create Student Account</h3>
      <div class="row">
        <div><label>Full Name</label><input id="rName"></div>
        <div><label>Email</label><input id="rEmail" type="email"></div>
        <div><label>Phone (WhatsApp)</label><input id="rPhone"></div>
      </div>
      <div class="row">
        <div><label>City</label><input id="rCity"></div>
        <div><label>Preferred Language</label>
          <select id="rLang"><option>English</option><option>Arabic</option><option>French</option></select>
        </div>
        <div><label>Password</label><input id="rPass" type="password"></div>
      </div>
      <button class="btn success" onclick="registerStudent()">Register & Go to Test</button>
    </div>
  </div>`;
}

function studentDashboard(){
  const bookings=db.get('bookings',[]).filter(b=>b.studentId===state.me.id);
  const next=bookings.find(b=>b.status==='confirmed')||bookings[0];
  const recs=bookings.filter(b=>b.recordingUrl);
  return `
  <div class="grid grid-2">
    <div class="card">
      <h3 class="title">Student Dashboard</h3>
      <p>Hello, <b>${state.me.name}</b></p>
      <div class="row">
        <div><span class="muted">Placement Level:</span> <b>${state.me.level||'-'}</b></div>
        <div><span class="muted">Recommended:</span> <b>${state.me.recommended||'-'}</b></div>
      </div>
      <div style="margin-top:8px">
        <button class="btn" onclick="setRoute('placement')">Take/Retake Placement Test</button>
        <button class="btn" onclick="setRoute('find')">Find a Teacher</button>
      </div>
    </div>
    <div class="card">
      <h4 class="title">Next Class</h4>
      ${next?`
        <div><b>${next.program}</b> with ${getTeacher(next.teacherId)?.name||'â€”'}</div>
        <div class="muted">${next.when}</div>
        <div>Status: <span class="badge">${next.status}</span> Â· Paid: <span class="badge">${next.paid?'Yes':'No'}</span></div>
        ${!next.paid?`
          <div style="margin-top:8px">
            <label>Upload Payment Receipt (placeholder)</label>
            <input type="text" id="payLink" placeholder="paste receipt URL or code"/>
            <button class="btn primary" onclick="uploadReceipt('${next.id}')">Submit</button>
          </div>`:''
        }
      `:'No bookings yet.'}
    </div>
  </div>
  <div class="card">
    <h4 class="title">Recorded Classes</h4>
    ${recs.length?`<ul>${recs.map(r=>`<li>${r.program} Â· ${r.when} â€” <a href="${r.recordingUrl}" target="_blank">Watch</a></li>`).join('')}</ul>`:'None yet.'}
  </div>
  <div style="margin-top:12px"><button class="btn" onclick="logout()">Logout</button></div>
  `;
}

function viewTeacher(){
  if(state.me?.role==='teacher' && state.me.approved) return teacherDashboard();
  if(state.me?.role==='teacher' && !state.me.approved) return `
    <div class="card"><h3 class="title">Teacher Onboarding</h3>
      <p>Status: <span class="badge">Pending Approval</span></p>
      <p class="muted">Admin will review your documents, interview & training status.</p>
      <button class="btn" onclick="logout()">Logout</button>
    </div>`;
  return `
  <div class="grid grid-2">
    <div class="card">
      <h3 class="title">Teacher Login</h3>
      <label>Email</label><input id="tEmail" type="email">
      <label>Password</label><input id="tPass" type="password">
      <div style="margin-top:8px"><button class="btn primary" onclick="login('teacher')">Login</button></div>
    </div>
    <div class="card">
      <h3 class="title">Apply as Teacher</h3>
      <div class="row">
        <div><label>Full Name</label><input id="aName"></div>
        <div><label>Email</label><input id="aEmail" type="email"></div>
        <div><label>Phone</label><input id="aPhone"></div>
      </div>
      <div class="row">
        <div><label>City</label><input id="aCity"></div>
        <div><label>Programs</label>
          <select id="aPrograms" multiple>
            <option>GEP</option><option>AEP</option><option>Training</option><option>GET</option>
          </select>
        </div>
        <div><label>Levels</label>
          <select id="aLevels" multiple>
            <option>A1</option><option>A2</option><option>B1</option><option>B2</option><option>C1</option>
          </select>
        </div>
      </div>
      <label>Short Bio</label><input id="aBio" placeholder="I help students speak with confidence."/>
      <label>Agree to policy</label><input id="aAgree" type="checkbox"/> I agree
      <div style="margin-top:8px"><button class="btn success" onclick="applyTeacher()">Submit Application</button></div>
    </div>
  </div>`;
}

function teacherDashboard(){
  const bookings=db.get('bookings',[]).filter(b=>b.teacherId===state.me.linkId);
  const today=bookings.slice(0,5);
  return `
  <div class="grid grid-2">
    <div class="card">
      <h3 class="title">Teacher Dashboard</h3>
      <p>Welcome, <b>${state.me.name}</b></p>
      <div class="row"><span class="pill">Policy: No private contact</span><span class="pill">All classes recorded</span></div>
    </div>
    <div class="card">
      <h4 class="title">Today / Upcoming</h4>
      ${today.length?`
        <table class="table">
          <tr><th>When</th><th>Student</th><th>Program</th><th>Actions</th></tr>
          ${today.map(b=>`
            <tr>
              <td>${b.when}</td>
              <td>${getUser(b.studentId)?.name||'â€”'}</td>
              <td>${b.program}</td>
              <td>
                <button class="btn" onclick="markReport('${b.id}')">Add Report</button>
                <button class="btn" onclick="addRecording('${b.id}')">Add Recording</button>
              </td>
            </tr>`).join('')}
        </table>
      `:'No classes yet.'}
    </div>
  </div>
  <div style="margin-top:12px"><button class="btn" onclick="logout()">Logout</button></div>
  `;
}

function viewApply(){ setRoute('teacher'); }

function viewAdmin(){
  if(state.me?.role!=='admin') {
    return `
    <div class="grid grid-2">
      <div class="card">
        <h3 class="title">Admin Login</h3>
        <label>Email</label><input id="aLEmail" type="email" value="admin@pecsb.demo">
        <label>Password</label><input id="aLPass" type="password" value="admin123">
        <button class="btn primary" style="margin-top:8px" onclick="login('admin')">Login</button>
      </div>
      <div class="card">
        <h3 class="title">Demo Accounts</h3>
        <ul>
          <li>Admin: <small class="code">admin@pecsb.demo / admin123</small></li>
          <li>Teacher: <small class="code">leila@pecsb.demo / teacher123</small></li>
          <li>Student: <small class="code">amina@pecsb.demo / student123</small></li>
        </ul>
      </div>
    </div>`;
  }
  const teachers=db.get('teachers',[]);
  const payments=db.get('payments',[]);
  const applicants=teachers.filter(t=>t.status!=='approved');
  const pendPay=payments.filter(p=>p.status==='pending');
  return `
  <div class="grid grid-3">
    <div class="card"><div class="kpi">${teachers.filter(t=>t.status==='approved').length}</div><div class="muted">Approved Teachers</div></div>
    <div class="card"><div class="kpi">${applicants.length}</div><div class="muted">Applicants to Review</div></div>
    <div class="card"><div class="kpi">${pendPay.length}</div><div class="muted">Payments to Verify</div></div>
  </div>
  <div class="grid grid-2" style="margin-top:12px">
    <div class="card">
      <h3 class="title">Teacher Applications</h3>
      ${applicants.length?`
        <table class="table">
          <tr><th>Name</th><th>City</th><th>Programs</th><th>Levels</th><th>Status</th><th></th></tr>
          ${applicants.map(a=>`
            <tr>
              <td>${a.name}</td><td>${a.city||'-'}</td>
              <td>${(a.programs||[]).join(', ')}</td>
              <td>${(a.levels||[]).join(', ')}</td>
              <td><span class="badge">${a.status}</span></td>
              <td>
                <button class="btn success" onclick="approveTeacher('${a.id}')">Approve</button>
                <button class="btn danger" onclick="rejectTeacher('${a.id}')">Reject</button>
              </td>
            </tr>`).join('')}
        </table>
      `:'No pending applications.'}
    </div>
    <div class="card">
      <h3 class="title">Payment Verifications</h3>
      ${pendPay.length?`
        <table class="table">
          <tr><th>Student</th><th>Amount</th><th>Method</th><th>Receipt</th><th></th></tr>
          ${pendPay.map(p=>`
            <tr>
              <td>${getUser(p.studentId)?.name||'-'}</td>
              <td>${p.amount}</td>
              <td>${p.method}</td>
              <td><a href="${p.receiptUrl||'#'}" target="_blank">${p.receiptUrl?'Open':'â€”'}</a></td>
              <td>
                <button class="btn success" onclick="verifyPayment('${p.id}',true)">Approve</button>
                <button class="btn danger" onclick="verifyPayment('${p.id}',false)">Reject</button>
              </td>
            </tr>`).join('')}
        </table>
      `:'No pending payments.'}
    </div>
  </div>
  <div style="margin-top:12px"><button class="btn" onclick="logout()">Logout</button></div>
  `;
}

function viewSupport(){
  return `
  <div class="grid grid-2">
    <div class="card">
      <h3 class="title">FAQ</h3>
      <p><b>How do I pay?</b> Bank transfer / Western Union / Flywire (if enabled). Upload the receipt in your Student Portal â†’ Next Class.</p>
      <p><b>Are classes recorded?</b> Yes, for quality and safety. Recordings are kept 30â€“90 days.</p>
      <p><b>Can I message my teacher?</b> Use the internal chat only. External contact is not allowed.</p>
    </div>
    <div class="card">
      <h3 class="title">Key Policies</h3>
      <ul>
        <li>Reschedule â‰¥ 12h before class (max 2 per course)</li>
        <li>No external payments or contacts</li>
        <li>Refunds: 100% within 7 days if no class taken; partial thereafter</li>
      </ul>
    </div>
  </div>
  `;
}

/* ======= QUIZ DEMO ======= */
const quizQs = Array.from({length:20}).map((_,i)=>({
  id:i+1, q:`Question ${i+1}: choose the correct option.`, a:["A","B","C","D"], correct: (i%4)
}));
function mountQuiz(){
  const qz = $('#quiz');
  qz.innerHTML = quizQs.map(q=>`
    <div class="card" style="padding:12px;margin-bottom:8px">
      <div><b>${q.q}</b></div>
      <div class="row">
        ${q.a.map((opt,idx)=>`
          <label style="display:flex;gap:6px;align-items:center">
            <input type="radio" name="q${q.id}" value="${idx}"/> ${opt}
          </label>`).join('')}
      </div>
    </div>`).join('');
}
function submitPlacement(){
  let score=0;
  quizQs.forEach(q=>{
    const sel=$(`input[name=q${q.id}]:checked`);
    if(sel && +sel.value===q.correct) score++;
  });
  const level = score<=8?'A1/A2':score<=15?'B1':'B2/C1';
  const rec = level.includes('A')?'GEP': level==='B1'?'AEP':'Training or AEP Advanced';
  const res=$('#quizResult');
  res.classList.remove('hide');
  res.innerHTML=`
    <h4 class="title">Your Result</h4>
    <p>Score: <b>${score}/20</b> Â· Level: <b>${level}</b></p>
    <p>Recommended program: <b>${rec}</b></p>
    <div class="row">
      <button class="btn" onclick="setRoute('find')">Book Free Trial</button>
      <button class="btn" onclick="setRoute('courses')">View Courses</button>
    </div>
  `;
  // store on profile if logged in
  if(state.me?.role==='student'){
    const users=db.get('users',[]);
    const u=users.find(x=>x.id===state.me.id);
    if(u){u.level=level;u.recommended=rec; db.set('users',users); state.me=u;}
  }
}

/* ======= AUTH ======= */
function getUser(id){ return db.get('users',[]).find(u=>u.id===id); }
function login(role){
  const email = role==='student' ? $('#sEmail')?.value : role==='teacher' ? $('#tEmail')?.value : $('#aLEmail')?.value;
  const pass  = role==='student' ? $('#sPass')?.value : role==='teacher' ? $('#tPass')?.value : $('#aLPass')?.value;
  const users=db.get('users',[]);
  const u=users.find(x=>x.email===email && x.pass===pass && x.role===role);
  if(!u){ setFlash('Invalid credentials'); render(); return; }
  state.me=u; setFlash(`Logged in as ${u.name}`); render();
}
function logout(){ state.me=null; setFlash('Logged out'); render(); }

function registerStudent(){
  const name=$('#rName').value.trim();
  const email=$('#rEmail').value.trim();
  const pass=$('#rPass').value.trim();
  if(!name||!email||!pass){ setFlash('Fill name, email, password'); render(); return; }
  const users=db.get('users',[]);
  if(users.some(u=>u.email===email)){ setFlash('Email already used'); render(); return; }
  const id=db.id();
  users.push({id, role:'student', name, email, pass});
  db.set('users',users);
  state.me=users.at(-1);
  setFlash('Account created. Take the placement test.');
  setRoute('placement');
}

/* ======= TEACHERS ======= */
function applyTeacher(){
  const name=$('#aName').value.trim();
  const email=$('#aEmail').value.trim();
  const agree=$('#aAgree').checked;
  if(!name||!email||!agree){ setFlash('Name, email, and agreement are required'); render(); return; }
  const programs=[...$('#aPrograms').selectedOptions].map(o=>o.value);
  const levels=[...$('#aLevels').selectedOptions].map(o=>o.value);
  const t={ id:db.id(), name, city:$('#aCity').value.trim(), programs, levels, status:'pending', badges:[], years:0, langs:["EN"], rating:0, taught:0, bio:$('#aBio').value.trim(), availability:[] };
  const teachers=db.get('teachers',[]); teachers.push(t); db.set('teachers',teachers);
  // create user record (not approved)
  const users=db.get('users',[]);
  users.push({id:db.id(), role:'teacher', email, pass:'changeme', name, linkId:t.id, approved:false});
  db.set('users',users);
  setFlash('Application submitted. Admin will review.');
  render();
}
function approveTeacher(id){
  const teachers=db.get('teachers',[]);
  const t=teachers.find(x=>x.id===id); if(!t) return;
  t.status='approved'; db.set('teachers',teachers);
  const users=db.get('users',[]);
  const u=users.find(x=>x.role==='teacher' && x.linkId===id);
  if(u){u.approved=true; db.set('users',users);}
  setFlash('Teacher approved'); render();
}
function rejectTeacher(id){
  const teachers=db.get('teachers',[]).filter(t=>t.id!==id);
  db.set('teachers',teachers);
  const users=db.get('users',[]).filter(u=>!(u.role==='teacher' && u.linkId===id));
  db.set('users',users);
  setFlash('Teacher rejected'); render();
}
function getTeacher(id){ return db.get('teachers',[]).find(t=>t.id===id); }

/* ======= BOOKINGS & PAYMENTS ======= */
function bookTrial(teacherId){
  if(!state.me || state.me.role!=='student'){ setFlash('Login as student first'); setRoute('student'); return; }
  const booking={ id:db.id(), studentId:state.me.id, teacherId, when:pickSlot(teacherId), program: state.me.recommended||'GEP', status:'pending', paid:false, receiptUrl:'' };
  const bookings=db.get('bookings',[]); bookings.push(booking); db.set('bookings',bookings);
  setFlash('Trial booked (pending). Upload receipt for verification.');
  setRoute('student');
}
function pickSlot(teacherId){
  const t=getTeacher(teacherId); return (t?.availability?.[0]||'Mon 18:00');
}
function uploadReceipt(bookingId){
  const url=$('#payLink').value.trim();
  if(!url){ setFlash('Paste a receipt URL/code'); render(); return; }
  const bookings=db.get('bookings',[]);
  const b=bookings.find(x=>x.id===bookingId); if(!b){ setFlash('Booking not found'); return; }
  b.receiptUrl=url; db.set('bookings',bookings);
  const payments=db.get('payments',[]);
  payments.push({id:db.id(), studentId:b.studentId, amount: (b.program==='GET'? 'weekly fee':'course fee'), method:'Bank/WU', receiptUrl:url, status:'pending'});
  db.set('payments',payments);
  setFlash('Receipt submitted. Finance will verify.');
  render();
}
function verifyPayment(pid, ok){
  const payments=db.get('payments',[]);
  const p=payments.find(x=>x.id===pid); if(!p) return;
  p.status= ok?'approved':'rejected';
  db.set('payments',payments);
  if(ok){
    // mark any pending booking of this student as paid & confirmed (demo)
    const bookings=db.get('bookings',[]);
    bookings.filter(b=>b.studentId===p.studentId && !b.paid).forEach(b=>{b.paid=true;b.status='confirmed';});
    db.set('bookings',bookings);
  }
  setFlash(ok?'Payment approved':'Payment rejected');
  render();
}

/* ======= TEACHER ACTIONS ======= */
function markReport(bookingId){
  const bookings=db.get('bookings',[]);
  const b=bookings.find(x=>x.id===bookingId);
  if(!b){ setFlash('Booking not found'); return; }
  b.report = {notes:'Covered speaking practice & past simple.', homework:'Write 150 words about your weekend.'};
  db.set('bookings',bookings);
  setFlash('Report saved'); render();
}
function addRecording(bookingId){
  const url=prompt('Paste recording URL (e.g., Zoom cloud link)');
  if(!url) return;
  const bookings=db.get('bookings',[]);
  const b=bookings.find(x=>x.id===bookingId); if(!b) return;
  b.recordingUrl=url; db.set('bookings',bookings);
  setFlash('Recording attached'); render();
}

/* ======= ROUTER ======= */
function view(){
  switch(state.route){
    case 'home': return viewHome();
    case 'courses': return viewCourses();
    case 'placement': return viewPlacement();
    case 'find': return viewFind();
    case 'pricing': return viewPricing();
    case 'how': return viewHow();
    case 'student': return viewStudent();
    case 'teacher': return viewTeacher();
    case 'apply': return viewApply();
    case 'admin': return viewAdmin();
    case 'support': return viewSupport();
    default: return '<div class="card">Not Found</div>';
  }
}
function render(){
  navView();
  $('#app').innerHTML = `
    ${state.flash?`<div class="card" style="border-left:6px solid var(--blue);margin-bottom:12px">${state.flash}</div>`:''}
    ${view()}
  `;
  if(state.route==='placement') mountQuiz();
}
render();
</script>
</body>
</html>
